<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP FICO Consultant Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container-bg {
            /* Reduced vertical padding slightly for mobile view, but kept h-screen feel */
            background: linear-gradient(135deg, #1f2937, #374151);
            min-height: 100vh;
            padding: 16px; /* Optimized padding for mobile */
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            padding: 1rem; /* Optimized padding for mobile */
            max-width: 900px;
            margin: 0 auto;
        }
        /* Override card padding for larger screens */
        @media (min-width: 640px) {
            .card {
                padding: 1.5rem;
            }
        }
        .gemini-response {
            white-space: pre-wrap;
            text-align: left;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .citation {
            font-size: 0.8rem;
            color: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container-bg flex flex-col items-center">
        <div class="card w-full">
            <!-- Explicitly set smaller text for mobile (text-2xl) and larger for sm:screens (sm:text-3xl) -->
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">SAP FICO Implementation Assistant</h1>
            <p class="text-sm sm:text-base text-gray-600 mb-6 text-center">Your expert guide for FICO configuration steps, concepts, and T-Codes.</p>

            <!-- Input Area 1: Implementation Query (Grounding Enabled) -->
            <!-- Explicitly set smaller text for mobile (text-lg) -->
            <h2 class="text-lg sm:text-xl font-semibold text-gray-700 mb-3">Implementation Query (Step-by-Step)</h2>
            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <input type="text" id="promptInput" placeholder="E.g., How to configure a new Company Code in SAP FICO?"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                       onkeypress="if(event.key === 'Enter') document.getElementById('askButton').click()">
                <button id="askButton" onclick="askFicoQuery()"
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] disabled:bg-indigo-400">
                    Ask Consultant
                </button>
            </div>

            <!-- Divider -->
            <div class="h-px bg-gray-300 mb-6"></div>

            <!-- New Input Area 3: FSD Analysis (Grounding Enabled) -->
            <h2 class="text-lg sm:text-xl font-semibold text-gray-700 mb-3">FSD Analysis & Solution Design üìù</h2>
            <div class="flex flex-col gap-3 mb-6">
                <textarea id="fsdInput" placeholder="Paste your FSD requirements here (e.g., 'We need to set up automatic clearing for G/L account 123456 and restrict it to document types KZ and SA.')."
                       rows="4"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150"></textarea>
                <button id="analyzeFsdButton" onclick="analyzeFSD()"
                        class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.01] disabled:bg-green-400">
                    Analyze FSD & Prepare Solution
                </button>
            </div>

            <!-- Divider -->
            <div class="h-px bg-gray-300 mb-6"></div>
            
            <!-- Input Area 2: Quick Explainer Query (LLM Only) -->
            <!-- Explicitly set smaller text for mobile (text-lg) -->
            <h2 class="text-lg sm:text-xl font-semibold text-gray-700 mb-3">Quick Concept Explainer ‚ú®</h2>
            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <input type="text" id="conceptInput" placeholder="E.g., T-code F-28, Document Splitting, or Cost Element"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150"
                       onkeypress="if(event.key === 'Enter') document.getElementById('explainButton').click()">
                <button id="explainButton" onclick="explainConceptQuery()"
                        class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150 transform hover:scale-[1.01] disabled:bg-purple-400">
                    Explain Concept ‚ú®
                </button>
            </div>


            <!-- Response Area -->
            <div id="responseContainer" class="mt-8">
                <div id="loadingIndicator" class="hidden flex justify-center items-center p-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-3"></div>
                    <p class="text-indigo-600 font-medium">Consultant is thinking...</p>
                </div>
                
                <!-- TTS Controls: Stacks on mobile, inline on sm:screens -->
                <div id="responseControls" class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                    <button id="ttsButton" onclick="generateTtsAudio()" disabled
                            class="px-4 py-2 bg-pink-600 text-white text-sm font-semibold rounded-full shadow-md hover:bg-pink-700 transition duration-150 disabled:bg-pink-400 mb-2 sm:mb-0">
                        Read Aloud ‚ú®
                    </button>
                    <!-- Audio player is full width on mobile -->
                    <audio id="audioPlayer" controls class="w-full sm:w-2/3 h-8 hidden"></audio>
                </div>
                
                <div id="responseText" class="gemini-response min-h-[100px] text-gray-700 hidden"></div>
                <div id="sourcesContainer" class="mt-4 border-t pt-3 border-gray-200 hidden">
                    <p class="font-semibold text-gray-600 mb-2">Sources:</p>
                    <ul id="sourcesList" class="space-y-1 citation"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Gemini API Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Canvas will provide this at runtime
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const TTS_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;
        
        // --- System Instructions ---
        const STEP_GUIDANCE_SYSTEM_PROMPT = "You are an expert SAP FICO Technical Consultant and Tutor. Your task is to provide concise, accurate, step-by-step guidance for configuration and implementation tasks in the SAP FICO module. Always include the relevant SAP Transaction Codes (T-Codes) and the configuration path when applicable. Format your response clearly using lists for steps. Do not include any introductory or concluding conversational text in your response, just the direct answer.";
        const EXPLAINER_SYSTEM_PROMPT = "You are a concise SAP FICO Glossary Expert. Provide a short, one-paragraph explanation (max 5 sentences) of the requested FICO term, T-Code, or concept. Focus on the 'What' and 'Why' in business terms. Do not use lists or step-by-step instructions. Respond directly.";
        const FSD_ANALYSIS_SYSTEM_PROMPT = "You are a Senior SAP FICO Solution Architect. You have been provided with functional requirements (FSD). Your task is to analyze the requirements and prepare a comprehensive, step-by-step technical configuration solution plan for the SAP environment. For each requirement, clearly state the necessary T-Codes, configuration paths, and detailed steps. Present the output as a structured implementation plan. Do not include any conversational introduction or conclusion.";


        // --- DOM Elements ---
        const promptInput = document.getElementById('promptInput');
        const conceptInput = document.getElementById('conceptInput');
        const fsdInput = document.getElementById('fsdInput'); 
        const askButton = document.getElementById('askButton');
        const explainButton = document.getElementById('explainButton');
        const analyzeFsdButton = document.getElementById('analyzeFsdButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const responseText = document.getElementById('responseText');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');
        const ttsButton = document.getElementById('ttsButton');
        const audioPlayer = document.getElementById('audioPlayer');

        /**
         * Converts the structured grounding sources into readable citation links.
         */
        function renderSources(sources) {
            sourcesList.innerHTML = '';
            if (sources && sources.length > 0) {
                sourcesContainer.classList.remove('hidden');
                sources.forEach((source, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 hover:underline transition duration-150">
                        ${index + 1}. ${source.title}
                    </a>`;
                    sourcesList.appendChild(li);
                });
            } else {
                 sourcesContainer.classList.add('hidden');
            }
        }
        
        // --- TTS Helper Functions ---

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper to write string to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Function to convert PCM data to WAV format (required for browser audio playback)
        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const wavData = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(wavData);

            // Write RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');

            // Write FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk size
            view.setUint16(20, 1, true);  // Audio format (1 for PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block align
            view.setUint16(34, bytesPerSample * 8, true); // Bits per sample

            // Write DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += bytesPerSample;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * Generates and plays audio for the current response text.
         */
        async function generateTtsAudio() {
            const textToSpeak = responseText.textContent.trim();

            if (responseText.classList.contains('hidden') || !textToSpeak) {
                responseText.textContent = "Please generate a text response first before using Text-to-Speech.";
                responseText.classList.remove('hidden');
                return;
            }
            
            // UI state management
            ttsButton.disabled = true;
            ttsButton.textContent = "Generating Audio...";
            audioPlayer.src = '';
            audioPlayer.classList.add('hidden');
            
            const ttsPayload = {
                contents: [{
                    parts: [{ text: textToSpeak }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            // Using Charon (Informative) voice
                            prebuiltVoiceConfig: { voiceName: "Charon" }
                        }
                    }
                },
            };

            const maxRetries = 3;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(TTS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ttsPayload)
                    });

                    if (response.status === 429 && attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`TTS API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        audioPlayer.src = audioUrl;
                        audioPlayer.classList.remove('hidden');
                        audioPlayer.play();
                        
                    } else {
                        console.error("Invalid TTS response structure or mime type:", mimeType);
                        responseText.textContent = "Failed to generate speech: Invalid audio format received.";
                    }
                    break; 
                } catch (error) {
                    console.error("TTS Generation Error:", error);
                    responseText.textContent = `Could not generate audio: ${error.message}`;
                }
            }
            
            // Final UI state update
            ttsButton.disabled = false;
            ttsButton.textContent = "Read Aloud ‚ú®";
        }

        /**
         * Core function to handle API calls and UI updates.
         */
        async function handleGeminiQuery(query, systemPrompt, useGrounding, successCallback) {
            // State reset
            loadingIndicator.classList.remove('hidden');
            responseText.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            audioPlayer.classList.add('hidden');
            ttsButton.disabled = true;
            responseText.textContent = '';
            sourcesList.innerHTML = '';
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: useGrounding ? [{ "google_search": {} }] : undefined,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        successCallback(candidate);
                        ttsButton.disabled = false; // Enable TTS after successful text generation
                    } else {
                        responseText.textContent = "Sorry, I couldn't find a detailed answer for that query. Please try phrasing it differently.";
                    }
                    
                    break; 
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    responseText.textContent = `An error occurred: ${error.message}. Please check the console for details.`;
                }
            }
            
            // Final UI state update
            loadingIndicator.classList.add('hidden');
            responseText.classList.remove('hidden');
        }

        /**
         * Handler for the main FICO Implementation Query (Uses Grounding).
         */
        async function askFicoQuery() {
            const userQuery = promptInput.value.trim();
            if (!userQuery) {
                responseText.textContent = "Please enter a FICO implementation query to proceed.";
                responseText.classList.remove('hidden');
                return;
            }
            
            askButton.disabled = true;
            explainButton.disabled = true;
            analyzeFsdButton.disabled = true; // Disable all primary buttons

            await handleGeminiQuery(userQuery, STEP_GUIDANCE_SYSTEM_PROMPT, true, (candidate) => {
                const text = candidate.content.parts[0].text;
                
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                responseText.textContent = text;
                renderSources(sources);
            });
            
            askButton.disabled = false;
            explainButton.disabled = false;
            analyzeFsdButton.disabled = false; // Re-enable all primary buttons
        }

        /**
         * Handler for the Quick Concept Explainer Query (LLM Only).
         */
        async function explainConceptQuery() {
            const userQuery = conceptInput.value.trim();
            if (!userQuery) {
                responseText.textContent = "Please enter a concept or T-code to explain.";
                responseText.classList.remove('hidden');
                return;
            }
            
            askButton.disabled = true;
            explainButton.disabled = true;
            analyzeFsdButton.disabled = true; // Disable all primary buttons

            await handleGeminiQuery(userQuery, EXPLAINER_SYSTEM_PROMPT, false, (candidate) => {
                const text = candidate.content.parts[0].text;
                responseText.textContent = text;
                renderSources([]); // Clear sources since no grounding was used
            });
            
            askButton.disabled = false;
            explainButton.disabled = false;
            analyzeFsdButton.disabled = false; // Re-enable all primary buttons
        }

        /**
         * Handler for the FSD Analysis Query (Uses Grounding).
         */
        async function analyzeFSD() {
            const userQuery = fsdInput.value.trim();
            if (!userQuery) {
                responseText.textContent = "Please paste the FSD requirements into the text area to analyze.";
                responseText.classList.remove('hidden');
                return;
            }
            
            // Disable all primary buttons during execution
            askButton.disabled = true;
            explainButton.disabled = true;
            analyzeFsdButton.disabled = true;

            // The query for FSD analysis is the content of the textarea
            const fullQuery = "Analyze the following FSD requirements and provide a technical solution plan:\n\n" + userQuery;

            await handleGeminiQuery(fullQuery, FSD_ANALYSIS_SYSTEM_PROMPT, true, (candidate) => {
                const text = candidate.content.parts[0].text;
                
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                responseText.textContent = text;
                renderSources(sources);
            });
            
            // Re-enable all primary buttons
            askButton.disabled = false;
            explainButton.disabled = false;
            analyzeFsdButton.disabled = false;
        }

    </script>
</body>
</html>
